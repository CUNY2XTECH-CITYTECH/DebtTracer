<%- include("partials/header.ejs") %>
<main class="content-container">
  <% 
    function formatCurrency(amount) { 
      return amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
    }
    // Localized labels for stored codes
    const freqLabel = (code) => ({
      'one-time': t('expenses.oneTime'),
      'weekly':   t('expenses.weekly'),
      'monthly':  t('expenses.monthly'),
    }[code] || code);

    const catLabel = (c) => ({
      'Housing':        t('expenses.housing'),
      'Food':           t('expenses.food'),
      'Transportation': t('expenses.transportation'),
      'Utilities':      t('expenses.utilities'),
      'Entertainment':  t('expenses.entertainment'),
    }[c] || c);
  %>

  <section class="expenses-section">
    <h1 class="mb-4" id="top-title-h1"><%= t('expenses.title') %></h1>

    <% if (typeof alert !== 'undefined' && alert) { %>
      <div class="alert alert-<%= alert.type %> alert-dismissible fade show mb-4">
        <i class="fas fa-<%= alert.type === 'success' ? 'check' : 'exclamation' %>-circle me-2"></i>
        <%= alert.message %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <div class="card mb-4">
      <div class="card-header">
        <h2 class="card-title"><%= t('expenses.addNew') %></h2>
      </div>
      <div class="card-body">
        <form action="/expenses" method="POST" class="expense-form">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="category" class="form-label"><%= t('expenses.category') %>*</label>
              <select class="form-select" id="category" name="category" required>
                <option value="" disabled selected><%= t('expenses.selectCategory') %></option>
                <!-- Canonical values; localized labels -->
                <option value="Housing"        <%= formData && formData.category === 'Housing' ? 'selected' : '' %>><%= t('expenses.housing') %></option>
                <option value="Food"           <%= formData && formData.category === 'Food' ? 'selected' : '' %>><%= t('expenses.food') %></option>
                <option value="Transportation" <%= formData && formData.category === 'Transportation' ? 'selected' : '' %>><%= t('expenses.transportation') %></option>
                <option value="Utilities"      <%= formData && formData.category === 'Utilities' ? 'selected' : '' %>><%= t('expenses.utilities') %></option>
                <option value="Entertainment"  <%= formData && formData.category === 'Entertainment' ? 'selected' : '' %>><%= t('expenses.entertainment') %></option>
              </select>
            </div>
            
            <div class="col-md-4">
              <label for="name" class="form-label"><%= t('expenses.name') %>*</label>
              <input 
                type="text" 
                class="form-control" 
                id="name" 
                name="name" 
                placeholder="<%= t('expenses.namePlaceholder') %>" 
                required
                value="<%= typeof formData !== 'undefined' ? formData.name : '' %>"
              >
            </div>

            <div class="col-md-4">
              <label for="amount" class="form-label"><%= t('expenses.amount') %>*</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input 
                  type="number" 
                  class="form-control" 
                  id="amount" 
                  name="amount" 
                  step="0.01" 
                  min="0.01" 
                  placeholder="0.00" 
                  required
                  value="<%= typeof formData !== 'undefined' ? formData.amount : '' %>"
                >
              </div>
            </div>

            <div class="col-md-4">
              <label for="date" class="form-label"><%= t('expenses.date') %>*</label>
              <input 
                type="date" 
                class="form-control" 
                id="date" 
                name="date" 
                required
                value="<%= typeof formData !== 'undefined' ? formData.date : new Date().toISOString().split('T')[0] %>"
              >
              <input type="hidden" id="timezoneOffset" name="timezoneOffset">
            </div>

            <div class="col-md-4">
              <label for="frequency" class="form-label"><%= t('expenses.frequency') %>*</label>
              <select class="form-select" id="frequency" name="frequency" <%= !formData || !formData.isRecurring ? 'disabled' : '' %>>
                <option value="one-time" <%= formData && formData.frequency === 'one-time' ? 'selected' : '' %>><%= t('expenses.oneTime') %></option>
                <option value="weekly"   <%= formData && formData.frequency === 'weekly'   ? 'selected' : '' %>><%= t('expenses.weekly') %></option>
                <option value="monthly"  <%= formData && formData.frequency === 'monthly'  ? 'selected' : '' %>><%= t('expenses.monthly') %></option>
              </select>
            </div>

            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check form-switch">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  id="isRecurring" 
                  name="isRecurring"
                  <%= formData && formData.isRecurring === 'on' ? 'checked' : '' %>
                >
                <label class="form-check-label" for="isRecurring"><%= t('expenses.recurring') %></label>
              </div>
            </div>

            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus-circle me-2"></i><%= t('expenses.addExpense') %>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="card-title mb-0"><%= t('expenses.history') %></h2>
        <span class="badge bg-danger fs-6">
          <%= t('expenses.total') %>: $<%= expenses.reduce((sum, e) => sum + e.amount, 0).toFixed(2) %>
        </span>
      </div>
      
      <div class="card-body p-0">
        <% if (expenses.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th><%= t('expenses.table.date') %></th>
                  <th><%= t('expenses.table.category') %></th>
                  <th><%= t('expenses.table.description') %></th>
                  <th><%= t('expenses.table.amount') %></th>
                  <th><%= t('expenses.table.recurrence') %></th>
                  <th><%= t('expenses.table.actions') %></th>
                </tr>
              </thead>
              <tbody>
                <% expenses.forEach(expense => { %>
                  <tr id="expense-row-<%= expense._id %>" class="<%= expense.isRecurring && expense.nextOccurrence && new Date(expense.nextOccurrence) < new Date() ? 'table-danger' : '' %>">
                    <td>
                      <% 
                        const utcDate = new Date(expense.date);
                        const localDate = new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate());
                      %>
                      <%= localDate.toLocaleDateString(lang || 'en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
                    </td>
                    <td>
                      <span id="category-display-<%= expense._id %>" class="badge bg-<%= 
                        expense.category === 'Housing' ? 'primary' : 
                        expense.category === 'Food' ? 'success' :
                        expense.category === 'Transportation' ? 'info' :
                        expense.category === 'Utilities' ? 'warning' : 'secondary'
                      %>">
                        <%= catLabel(expense.category) %>
                      </span>
                      <select class="form-select d-none" id="category-edit-<%= expense._id %>">
                        <!-- Canonical values; localized labels -->
                        <option value="Housing"        <%= expense.category === 'Housing' ? 'selected' : '' %>><%= t('expenses.housing') %></option>
                        <option value="Food"           <%= expense.category === 'Food' ? 'selected' : '' %>><%= t('expenses.food') %></option>
                        <option value="Transportation" <%= expense.category === 'Transportation' ? 'selected' : '' %>><%= t('expenses.transportation') %></option>
                        <option value="Utilities"      <%= expense.category === 'Utilities' ? 'selected' : '' %>><%= t('expenses.utilities') %></option>
                        <option value="Entertainment"  <%= expense.category === 'Entertainment' ? 'selected' : '' %>><%= t('expenses.entertainment') %></option>
                      </select>
                    </td>
                    <td>
                      <span id="name-display-<%= expense._id %>"><%= expense.name %></span>
                      <input type="text" class="form-control d-none" id="name-edit-<%= expense._id %>" value="<%= expense.name %>">
                    </td>
                    <td class="fw-bold">
                      <span id="amount-display-<%= expense._id %>">$<%= expense.amount.toFixed(2) %></span>
                      <div class="input-group d-none" id="amount-edit-<%= expense._id %>">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" value="<%= expense.amount.toFixed(2) %>" step="0.01" min="0.01">
                      </div>
                    </td>
                    <td>
                      <% if (expense.isRecurring) { %>
                        <span id="frequency-display-<%= expense._id %>" class="badge bg-<%= 
                          expense.frequency === 'weekly' ? 'info' :
                          expense.frequency === 'monthly' ? 'warning' : 'secondary'
                        %>">
                          <i class="fas fa-repeat me-1"></i>
                          <%= freqLabel(expense.frequency) %>
                        </span>
                      <% } else { %>
                        <span id="frequency-display-<%= expense._id %>" class="badge bg-secondary">
                          <i class="fas fa-times me-1"></i> <%= t('expenses.oneTime') %>
                        </span>
                      <% } %>
                      <div class="d-none" id="frequency-edit-container-<%= expense._id %>">
                        <div class="form-check form-switch mb-2">
                          <input class="form-check-input" type="checkbox" id="isRecurring-edit-<%= expense._id %>" <%= expense.isRecurring ? 'checked' : '' %>>
                          <label class="form-check-label" for="isRecurring-edit-<%= expense._id %>"><%= t('expenses.recurring') %></label>
                        </div>
                        <select class="form-select" id="frequency-edit-<%= expense._id %>" <%= !expense.isRecurring ? 'disabled' : '' %>>
                          <option value="one-time" <%= expense.frequency === 'one-time' ? 'selected' : '' %>><%= t('expenses.oneTime') %></option>
                          <option value="weekly"   <%= expense.frequency === 'weekly' ? 'selected' : '' %>><%= t('expenses.weekly') %></option>
                          <option value="monthly"  <%= expense.frequency === 'monthly' ? 'selected' : '' %>><%= t('expenses.monthly') %></option>
                        </select>
                      </div>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm" id="action-buttons-<%= expense._id %>">
                        <button class="btn btn-outline-primary edit-expense" data-id="<%= expense._id %>">
                          <i class="fas fa-edit"></i>
                          <span class="d-none d-sm-inline">Edit</span>
                        </button>
                        <button class="btn btn-outline-danger delete-expense" data-id="<%= expense._id %>">
                          <i class="fas fa-trash-alt"></i>
                          <span class="d-none d-sm-inline"><%= t('expenses.delete') %></span>
                        </button>
                      </div>
                      <div class="btn-group btn-group-sm d-none" id="save-buttons-<%= expense._id %>">
                        <button class="btn btn-success save-expense" data-id="<%= expense._id %>">
                          <i class="fas fa-save"></i>
                          <span class="d-none d-sm-inline">Save</span>
                        </button>
                        <button class="btn btn-outline-secondary cancel-edit" data-id="<%= expense._id %>">
                          <i class="fas fa-times"></i>
                          <span class="d-none d-sm-inline">Cancel</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-info m-3">
            <i class="fas fa-info-circle me-2"></i><%= t('expenses.noRecords') %>
          </div>
        <% } %>
      </div>
    </div>
  </section>

<%- include('partials/footer') %>
